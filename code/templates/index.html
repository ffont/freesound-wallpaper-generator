<html>
	<head>
		<title>Freesound Wallpapers</title>
		<script src="{% if application_root %}/{{ application_root }}{% endif %}/static/socket.io.min.js"></script>
		<script type="text/javascript" charset="utf-8">

			// Default sound IDs
			var default_sound_ids = [1234, 433127, 32405, 76907, 262480, 291164, 13800, 53922, 106595];

			// Establish web sockets connection in specific namespace
		    var socket = io.connect('{{ base_url }}', {'path': '{% if application_root %}/{{ application_root }}{% endif %}/socket.io'});
		    socket.on('connect', function() {
		        socket.emit('connected', {message: 'Client ready!'});
		    });
		    socket.on('connected_response', function(data) {
		        console.log(data.message)
		    });

		    // Update UI on progress report
		    socket.on('progress_report', function(data) {
		        var total_percentage = data.total_percentage;
		        
		        var percentageIndicator = document.getElementById('percentage_indicator');
		        percentageIndicator.innerHTML = ' (' + total_percentage + '%)'

		        if (total_percentage == 100){
		        	percentageIndicator.innerHTML = 'Loading images...';

		        	setTimeout(function(){
		        		percentageIndicator.innerHTML = '';
		        		Object.keys(data['urls']).forEach(function(key) {
		        			var color_scheme = key;
		        			
		        			// Add spectrogram image
							var img = document.createElement('img');
							img.src = data['urls'][key]['url_spectrogram'];
							document.getElementById('wallpapers_container').appendChild(img);

							// Add waveform image
							var img = document.createElement('img');
							img.src = data['urls'][key]['url_waveform'];
							document.getElementById('wallpapers_container').appendChild(img);
						});
		        	}, 5000);  // Wait some ms so that link to static image works properly
		        }
		    });

		    window.getDevicePixelRatio = function () {
		    		// from https://gist.github.com/homm/b2d8e6a5f35811084894106f421d1f58
				    var ratio = 1;
				    // To account for zoom, change to use deviceXDPI instead of systemXDPI
				    if (window.screen.systemXDPI !== undefined && window.screen.logicalXDPI !== undefined && window.screen.systemXDPI > window.screen.logicalXDPI) {
				        // Only allow for values > 1
				        ratio = window.screen.systemXDPI / window.screen.logicalXDPI;
				    }
				    else if (window.devicePixelRatio !== undefined) {
				        ratio = window.devicePixelRatio;
				    }
				    return ratio;
				};

		    function getDefaultSize(){
				var ratio = window.getDevicePixelRatio();
				var w = screen.width * ratio;
				var h = screen.height * ratio;
				return {w: w, h: h}
		    }

		    function init(){
		    	defaultSize = getDefaultSize();
		    	document.getElementById('width').value = defaultSize.w;
		    	document.getElementById('height').value = defaultSize.h;
		    	document.getElementById('fsid').value = default_sound_ids[Math.floor(Math.random() * default_sound_ids.length)];
		    }

		    function numberInRange(number, min, max){
		    	var numberInt = parseInt(number, 10);
		    	if (numberInt < min){
		    		return parseInt(min, 10);
		    	} else if (numberInt > max){
		    		return parseInt(max, 10);
		    	} else {
		    		return numberInt
		    	}
		    }

		    // Trigger wallpaper creation
		    function triggerCreateWallpaper(){
		    	document.getElementById('wallpapers_container').innerHTML = '';
		    	var percentageIndicator = document.getElementById('percentage_indicator');
		    	percentageIndicator.innerHTML = 'Downloading sound...';
		    	socket.emit('create_wallpaper', {
		    		sound_id: document.getElementById('fsid').value,
		    		width: numberInRange(document.getElementById('width').value, 20, 10000),
		    		height: numberInRange(document.getElementById('height').value, 20, 10000),
		    		fft_size: 2048,
		    	});
		    }
		</script>
	</head>
	<body onload="init()">
		<h1>Freesound Wallpapers</h1>
		<p>Code and description <a href="https://github.com/ffont/freesound-wallpaper-generator">here</a></p>
		<label for="fsid">Freesound ID:</label>
	    <input type="number" id="fsid" name="fsid" step="1" />
	    <label for="width">Width:</label>
	    <input type="number" id="width" name="width" step="1" />
	    <label for="height">Height:</label>
	    <input type="number" id="height" name="height" step="1" />
	    <input type="button" value="Go!" onclick="triggerCreateWallpaper();">
		<span id="percentage_indicator"></span>
		<div id="wallpapers_container" style="margin-top:20px;"></div>
	</body>
</html>